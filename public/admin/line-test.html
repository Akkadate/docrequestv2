<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Notification - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="dashboard.html">
          <i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
        </a>
        <a class="nav-link" href="#" id="logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="mb-4">üîî ‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE Notification</h2>
    
    <div id="alert-container"></div>
    
    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE</h5>
          </div>
          <div class="card-body">
            <div id="config-status">
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
                <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...</p>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h5>
          </div>
          <div class="card-body">
            <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Official Account</p>
            <button id="test-btn" class="btn btn-success" disabled>
              <i class="bi bi-send"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
            <div id="test-result" class="mt-3"></div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE</h6>
          </div>
          <div class="card-body">
            <ol class="small">
              <li>‡∏™‡∏£‡πâ‡∏≤‡∏á LINE Official Account</li>
              <li>‡∏™‡∏£‡πâ‡∏≤‡∏á Channel ‡πÉ‡∏ô LINE Developers Console</li>
              <li>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Channel Access Token</li>
              <li>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô LINE ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å User ID</li>
              <li>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå .env:
                <pre class="mt-2 p-2 bg-light"><code>LINE_CHANNEL_ACCESS_TOKEN=xxx
LINE_ADMIN_USER_ID=xxx</code></pre>
              </li>
              <li>‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</li>
            </ol>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0">üìã ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h6>
          </div>
          <div class="card-body">
            <p class="small mb-0">
              ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠:
            </p>
            <ul class="small">
              <li>‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</li>
              <li>‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</li>
              <li>‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    const token = localStorage.getItem('token');
    const userRole = localStorage.getItem('userRole');
    
    if (!token || userRole !== 'admin') {
      window.location.href = '../login.html';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alert);
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    async function loadConfig() {
      try {
        const response = await fetch('/api/admin/line-config', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const config = await response.json();
        displayConfig(config);
      } catch (error) {
        console.error('Error loading config:', error);
        document.getElementById('config-status').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
          </div>
        `;
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    function displayConfig(config) {
      const statusContainer = document.getElementById('config-status');
      const testBtn = document.getElementById('test-btn');

      if (config.configured) {
        let modeText = '';
        let modeIcon = '';
        
        if (config.mode === 'group') {
          modeText = '‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE Group';
          modeIcon = 'üë•';
        } else if (config.mode === 'multiple') {
          modeText = `‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô (${config.targetCount} ‡∏Ñ‡∏ô)`;
          modeIcon = 'üë§üë§';
        } else {
          modeText = '‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Admin ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
          modeIcon = 'üë§';
        }

        let targetsList = '';
        if (config.targets && config.targets.length > 0) {
          targetsList = config.targets.map(target => 
            `<li>${target.type === 'group' ? 'üë•' : 'üë§'} ${target.name}: ${target.id}</li>`
          ).join('');
        }

        statusContainer.innerHTML = `
          <div class="alert alert-success">
            <h6><i class="bi bi-check-circle"></i> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h6>
            <div class="row">
              <div class="col-md-6">
                <ul class="mb-0">
                  <li>Channel Access Token: ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß</li>
                  <li>‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á: ${modeIcon} ${modeText}</li>
                </ul>
              </div>
              <div class="col-md-6">
                <strong>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á:</strong>
                <ul class="mb-0 small">${targetsList}</ul>
              </div>
            </div>
          </div>
        `;
        testBtn.disabled = false;
      } else {
        statusContainer.innerHTML = `
          <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle"></i> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</h6>
            <ul class="mb-0">
              <li>Channel Access Token: ${config.hasAccessToken ? '‚úÖ' : '‚ùå'}</li>
              <li>Notification Targets: ${config.targetCount > 0 ? '‚úÖ' : '‚ùå'} (${config.targetCount} targets)</li>
            </ul>
            <p class="mt-2 mb-0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå .env ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</p>
          </div>
        `;
        testBtn.disabled = true;
      }
    }

    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    async function testNotification() {
      const testBtn = document.getElementById('test-btn');
      const testResult = document.getElementById('test-result');
      
      testBtn.disabled = true;
      testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
      
      try {
        const response = await fetch('/api/admin/test-line-notification', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (response.ok) {
          testResult.innerHTML = `
            <div class="alert alert-success">
              <i class="bi bi-check-circle"></i> ${result.message}
            </div>
          `;
          showAlert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô LINE', 'success');
        } else {
          testResult.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-x-circle"></i> ${result.message}
            </div>
          `;
          showAlert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'danger');
        }
      } catch (error) {
        console.error('Error testing notification:', error);
        testResult.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-x-circle"></i> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
          </div>
        `;
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'danger');
      } finally {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="bi bi-send"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
      }
    }

    // Event listeners
    document.getElementById('test-btn').addEventListener('click', testNotification);
    
    document.getElementById('logout').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.clear();
      window.location.href = '../login.html';
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    document.addEventListener('DOMContentLoaded', loadConfig);
  </script>
</body>
</html>
